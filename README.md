# Data-infrastructure

個人分析用のデータ基盤構築用リポジトリ

無料版GithubはWikiの機能が使えないので、諸々をREADME.mdにまとめます。

## システム構想

マイクロサービスアーキテクチャを採用し、個々のコンポーネントを独立に開発できるようにする予定です。

サービス毎に複数のDockerコンテナを準備し、オーケストレーションはkubernetesで行う予定です。

採用のモチベーションは

1. 分析自体が探索的であり、全体の要件は変わっていくので局所的・個別に開発を進めていきたい
2. 共同開発の際に特定のサービスを任せることができる （コンテナにより開発環境の違いも軽減される）
3. モダンなシステム設計・開発手法の自己学習

などなど。

- システム概要

![system architecture](https://user-images.githubusercontent.com/56133802/75120700-c6fee000-56d0-11ea-9aef-3acb68ee168e.png)

## インストール

Dockerコンテナ化がまだなので、現状はローカルでパッケージをインストールします。

各々でPython仮想環境を用意し、リポジトリで管理している`requirements.txt`をもとに下記コマンドでインストールを実施してください。

```
pip install -r requirements.txt
```

**Docker導入時にインストール手順を更新します**

## データベース

こちらもコンテナ化がまだなので、現状はローカルにpostgresql12.1をインストールしています。

本リポジトリは単純なCRUD処理がメインなので、SQLAlchemyのORM機能を使用しています。

データベースの接続情報はソースコードに直書きせず、トラッキング対象外の`.env`ファイルに下記のように記載してローカルで管理します。

```
POSTGRESQL_USER=*****
POSTGRESQL_PASSWORD=***********
POSTGRESQL_HOST=localhost
POSTGRESQL_PORT=5432
・・・
```

テーブル作成は、`.env`ファイルの環境変数をロードした状態で`python ./src/migrate.py`により作成されます。

`forego`コマンドを使うとカレントディレクトリの`.env`を環境変数にロードして、

```
forego run python ./src/migrate.py
```

により楽に実行できます。

Macの場合、`brew install forego`でインストールできます。

**Docker導入時にインストール手順を更新します**

## ソフトウェアテスト

テストパッケージとして`fixture`等の便利機能が豊富な、`pytest`を使用しています。

データベース絡みのテストはテスト用DBを用意しています。

単体テスト・機能テストレベルで現状考えていることは、

- 実行速度が遅いテストはmark機能により、自動テストからは除外する
- テストの意図や目的を、テストメソッドのコメント等に残す
- 不要なテストはメンテナンスするか削除する
- テストカバレッジはあくまで指標であり、優先度次第では犠牲にする

などがあります。

テスト観点・テスト戦略については固まってからまとめたいと思います。

## コーディングスタイル

- flake8

`flake8`を採用しています。`flake8`は、pep8・pyflakes・循環的複雑度のチェックからなるラッパーライブラリです。

vscodeのコマンドパレットを開き、`Python: Select Linter`から`flake8`を選択することで有効化できます。

- 自己文書化 (docstringのすすめ)

`numpydoc`を採用しています。自己文書化のメリットとして、

1. 実装とドキュメントがセットになっていることで、古びたドキュメントのリスクが格段に減ること
2. コードの可読性が上がり、開発効率が上がること
3. コードからドキュメント生成が可能

引数や戻り値の情報以外に、オブジェクトの責務や、処理の目的といった設計時の観点をコメントに残しておくことが良いと思われます。

参考： [Python]可読性を上げるための、docstringの書き方を学ぶ（NumPyスタイル）　https://qiita.com/simonritchie/items/49e0813508cad4876b5a

